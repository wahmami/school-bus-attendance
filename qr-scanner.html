<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Code Scanner</title>
  <script src="./html5-qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    #qr-reader { width: 300px; margin-top: 1em; }
    #result { margin-top: 1em; }
  </style>
</head>
<body>
  <h1>QR Code Scanner</h1>
  <div id="qr-reader"></div>
  <div id="result"></div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let lastStudent = null;
      function onScanSuccess(decodedText, decodedResult) {
        document.getElementById('result').innerHTML = `<b>Scanned Data:</b> ${decodedText}`;
        try {
          const data = JSON.parse(decodedText);
          if (data.id && data.name) {
            lastStudent = data;
            document.getElementById('result').innerHTML += `<br><b>Student ID:</b> ${data.id}<br><b>Name:</b> ${data.name}`;
            checkInStudent(data.id);
          } else {
            document.getElementById('result').innerHTML += '<br><span style="color:red">Invalid QR format</span>';
          }
        } catch (e) {
          document.getElementById('result').innerHTML += '<br><span style="color:red">Invalid QR format</span>';
        }
      }

      let qrReader = null;
      function checkInStudent(studentId) {
        // Supabase attendance integration
        const SUPABASE_URL = 'https://lwdgtnmasuxphgydxppb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3ZGd0bm1hc3V4cGhneWR4cHBiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMTMyMjEsImV4cCI6MjA3NDU4OTIyMX0.eolrB6h-YUhFAm2NCTprz84yi2Cve-9AfTGmHCrOJ4c';
        const today = new Date().toISOString().slice(0, 10);
        // First, check if already checked in today
        fetch(`${SUPABASE_URL}/rest/v1/attendance?studentid=eq.${studentId}&date=eq.${today}`, {
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json'
          }
        })
        .then(res => res.json())
        .then(records => {
          if (records.length > 0) {
            document.getElementById('result').innerHTML += `<br><span style='color:orange'>Already checked in today!</span>`;
            if (qrReader) qrReader.stop();
          } else {
            const attendance = {
              studentid: studentId,
              date: today,
              checked: true
            };
            fetch(`${SUPABASE_URL}/rest/v1/attendance`, {
              method: 'POST',
              headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
              },
              body: JSON.stringify([attendance])
            })
            .then(res => res.json())
            .then(data => {
              document.getElementById('result').innerHTML += `<br><span style='color:green'>Attendance checked in!</span>`;
              if (qrReader) qrReader.stop();
            })
            .catch(err => {
              document.getElementById('result').innerHTML += `<br><span style='color:red'>Attendance check-in failed.</span>`;
            });
          }
        })
        .catch(err => {
          document.getElementById('result').innerHTML = `<br><span style='color:red'>Attendance check-in failed.</span>`;
        });
      }

      if (window.Html5Qrcode) {
        qrReader = new Html5Qrcode("qr-reader");
        qrReader.start(
          { facingMode: "environment" },
          {
            fps: 10,
            qrbox: 250
          },
          onScanSuccess,
          errorMessage => {
            document.getElementById('result').innerHTML = `<span style='color:red'>Camera error: ${errorMessage}</span>`;
          }
        ).catch(err => {
          document.getElementById('result').innerHTML = `<span style='color:red'>Camera error: ${err}</span>`;
        });
      } else {
        document.getElementById('result').innerHTML = `<span style='color:red'>QR code library failed to load.</span>`;
      }
    });
  </script>
</body>
</html>
